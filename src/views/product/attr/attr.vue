<template>
  <Category :flag="flag"></Category>
  <el-card style="margin-top: 20px">
    <div v-show="!flag">
      <el-button
        type="primary"
        :disabled="CategoryStore.c3Id ? false : true"
        @click="add"
        >添加平台属性</el-button
      >
      <el-form style="margin-top: 20px">
        <el-table
          :data="attrArr"
          style="width: 100%"
          border
          v-if="attrArr.length"
        >
          <el-table-column
            type="index"
            label="序号"
            width="80"
            align="center"
          />
          <el-table-column prop="attrName" label="属性名称" width="100" />
          <el-table-column label="属性值名称">
            <template #="{ row, $index }">
              <el-tag
                v-for="value in row.attrValueList"
                :type="value.id % 2 ? 'success' : 'info'"
                :key="value.id"
                style="margin: 0 5px"
                >{{ value.valueName }}</el-tag
              >
            </template> </el-table-column
          >>
          <el-table-column label="操作" width="200">
            <template #="{ row, $index }">
              <el-button type="warning" size="small" :icon="Edit"></el-button>
              <el-button type="danger" size="small" :icon="Delete"></el-button>
            </template>
          </el-table-column>
        </el-table>
        <el-empty description="网络异常" v-else></el-empty>
      </el-form>
    </div>
    <div v-show="flag == 1">
      <el-form>
        <el-form-item label="属性名称">
          <el-input placeholder="请您输入属性的名字" v-model="addSearchParams.attrName"></el-input>
        </el-form-item>
      </el-form>
      <el-button type="primary" :icon="Plus" @click="addValue" :disabled="addSearchParams.attrName ? false : true">添加属性值</el-button>
      <el-button @click="cancel">取消</el-button>
      <el-table border style="margin: 20px 0" :data="addSearchParams.attrValueList">
        <el-table-column
          width="80"
          type="index"
          label="序号"
          align="center"
        ></el-table-column>
        <el-table-column label="属性值">
          <template #="{ row, $index }">
            <el-input v-model="row.valueName"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="操作">
          <template #="{ row, $index }">
            <el-button type="warning" :icon="Edit"></el-button>
            <el-button type="danger" :icon="Delete"></el-button>
          </template>
        </el-table-column>
      </el-table>
      <el-button type="primary" @click="save" :disabled="addSearchParams.attrValueList.length ? false: true">保存</el-button>
      <el-button @click="cancel">取消</el-button>
    </div>
  </el-card>
</template>

<script setup lang='ts'>
import Category from "@/components/Category/index.vue";
import { useCategoryStore } from "@/stores/category";
import { reactive, ref, watch } from "vue";
import { reqAddattrOrUpdateAttr, reqAttrInfo } from "@/api/product/attr";
import { Delete, Edit, Plus } from "@element-plus/icons-vue";
import { ElMessage } from "element-plus";

let CategoryStore = useCategoryStore();

let attrArr: any = ref([]);
let flag = ref(0);

// 定义获取表单数据
let addSearchParams: any = ref({
  attrName: '',
  attrValueList: [],
  categoryId: '',
  categoryLevel: 3
});

// 监听三级标题的变化，发送请求获取数据
watch(
  () => CategoryStore.c3Id,
  () => {
    attrArr.value = [];
    if (!CategoryStore.c3Id) return;
    GetAttrInfo();
  }
);

// 定义获取平台属性的函数
const GetAttrInfo = async () => {
  let { c1Id, c2Id, c3Id } = CategoryStore;
  let result = await reqAttrInfo(c1Id, c2Id, c3Id);
  attrArr.value = result;
}

// 点击取消的回调
const cancel = () => {
  flag.value = 0;
};

// 点击添加属性值的回调
let addValue = () => {
  addSearchParams.value.attrValueList.push({
    valueName: ''
  })
}

// 点击会触发跳转的回调
const add = () => {
  flag.value = 1;
  addSearchParams.value = {
  attrName: '',
  attrValueList: [],
  categoryId: CategoryStore.c3Id,
  categoryLevel: 3
}
};

// 点击保存的回调
const save = async () => {
  if(addSearchParams.value.attrValueList.length) {
    try {
      await reqAddattrOrUpdateAttr(addSearchParams.value);
    ElMessage.success('添加成功');
    flag.value = 0;
    GetAttrInfo();
    }catch(e) {
      ElMessage.error('添加失败');
    }
  }
}


</script>

<style scoped>
</style>